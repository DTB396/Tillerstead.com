(()=>{(function(){"use strict";class i{constructor(){this.photos=[],this.quoteData={customer:{},project:{},areas:[],materials:[],timeline:null,total:0},this.init()}init(){this.setupPhotoUpload(),this.setupMultiAreaQuote(),this.setupPDFGeneration(),this.setupEmailQuote(),this.setupQuoteSaveLoad()}setupPhotoUpload(){const e=document.getElementById("quote-photo-upload");if(!e)return;e.addEventListener("dragover",a=>{a.preventDefault(),e.classList.add("drag-over")}),e.addEventListener("dragleave",()=>{e.classList.remove("drag-over")}),e.addEventListener("drop",a=>{a.preventDefault(),e.classList.remove("drag-over"),this.handleFiles(a.dataTransfer.files)});const t=document.getElementById("photo-files");t&&t.addEventListener("change",a=>{this.handleFiles(a.target.files)})}handleFiles(e){Array.from(e).forEach((o,s)=>{if(this.photos.length>=10){this.showToast("Maximum 10 photos allowed","warning");return}if(o.size>5242880){this.showToast(`${o.name} is too large (max 5MB)`,"error");return}if(!o.type.startsWith("image/")){this.showToast(`${o.name} is not an image`,"error");return}const n=new FileReader;n.onload=l=>{const r={id:Date.now()+s,name:o.name,data:l.target.result,notes:""};this.photos.push(r),this.renderPhotoGallery()},n.readAsDataURL(o)})}renderPhotoGallery(){const e=document.getElementById("photo-gallery");e&&(e.innerHTML=this.photos.map(t=>`
        <div class="photo-item" data-photo-id="${t.id}">
          <img src="${t.data}" alt="${t.name}">
          <div class="photo-overlay">
            <button class="btn-icon" onclick="quoteSystem.removePhoto(${t.id})">
              <span>\u{1F5D1}\uFE0F</span>
            </button>
            <button class="btn-icon" onclick="quoteSystem.addPhotoNote(${t.id})">
              <span>\u{1F4DD}</span>
            </button>
          </div>
          ${t.notes?`<p class="photo-note">${t.notes}</p>`:""}
        </div>
      `).join(""))}removePhoto(e){this.photos=this.photos.filter(t=>t.id!==e),this.renderPhotoGallery()}addPhotoNote(e){const t=this.photos.find(o=>o.id===e);if(!t)return;const a=prompt("Add a note for this photo:",t.notes);a!==null&&(t.notes=a,this.renderPhotoGallery())}setupMultiAreaQuote(){const e=document.getElementById("add-quote-area");e&&e.addEventListener("click",()=>this.addProjectArea())}addProjectArea(){const e={id:Date.now(),name:"",sqft:0,material:"",labor:0,materials:0,subtotal:0};this.quoteData.areas.push(e),this.renderProjectAreas()}renderProjectAreas(){const e=document.getElementById("project-areas");e&&(e.innerHTML=this.quoteData.areas.map((t,a)=>`
        <div class="quote-area-card" data-area-id="${t.id}">
          <div class="area-header">
            <h4>Area ${a+1}</h4>
            <button class="btn-remove" onclick="quoteSystem.removeArea(${t.id})">Remove</button>
          </div>
          <div class="form-grid">
            <div class="form-field">
              <label>Area Name</label>
              <input type="text" value="${t.name}" 
                     onchange="quoteSystem.updateArea(${t.id}, 'name', this.value)"
                     placeholder="e.g., Master Bathroom">
            </div>
            <div class="form-field">
              <label>Square Footage</label>
              <input type="number" value="${t.sqft}" 
                     onchange="quoteSystem.updateArea(${t.id}, 'sqft', parseFloat(this.value))"
                     min="0" step="0.1">
            </div>
            <div class="form-field">
              <label>Material Type</label>
              <select onchange="quoteSystem.updateArea(${t.id}, 'material', this.value)">
                <option value="">Select material...</option>
                <option value="ceramic" ${t.material==="ceramic"?"selected":""}>Ceramic Tile</option>
                <option value="porcelain" ${t.material==="porcelain"?"selected":""}>Porcelain Tile</option>
                <option value="natural-stone" ${t.material==="natural-stone"?"selected":""}>Natural Stone</option>
                <option value="lft" ${t.material==="lft"?"selected":""}>Large Format Tile</option>
                <option value="mosaic" ${t.material==="mosaic"?"selected":""}>Mosaic</option>
              </select>
            </div>
          </div>
          <div class="area-estimate">
            <div class="estimate-line">
              <span>Labor:</span>
              <span class="amount">$${t.labor.toFixed(2)}</span>
            </div>
            <div class="estimate-line">
              <span>Materials:</span>
              <span class="amount">$${t.materials.toFixed(2)}</span>
            </div>
            <div class="estimate-line total">
              <span>Area Subtotal:</span>
              <span class="amount">$${t.subtotal.toFixed(2)}</span>
            </div>
          </div>
        </div>
      `).join(""),this.calculateQuoteTotal())}updateArea(e,t,a){const o=this.quoteData.areas.find(s=>s.id===e);o&&(o[t]=a,(t==="sqft"||t==="material")&&this.calculateAreaCost(o),this.renderProjectAreas())}calculateAreaCost(e){const t={ceramic:8,porcelain:10,"natural-stone":12,lft:14,mosaic:16},a={ceramic:5,porcelain:8,"natural-stone":15,lft:12,mosaic:20},o=t[e.material]||10,s=a[e.material]||8;e.labor=e.sqft*o,e.materials=e.sqft*s*1.15,e.subtotal=e.labor+e.materials}removeArea(e){this.quoteData.areas=this.quoteData.areas.filter(t=>t.id!==e),this.renderProjectAreas()}calculateQuoteTotal(){const e=this.quoteData.areas.reduce((a,o)=>a+o.subtotal,0);this.quoteData.total=e;const t=document.getElementById("quote-total");t&&(t.textContent=`$${e.toFixed(2)}`)}setupPDFGeneration(){const e=document.getElementById("generate-quote-pdf");e&&e.addEventListener("click",()=>this.generatePDF())}async generatePDF(){if(typeof jspdf=="undefined"){this.showToast("PDF library not loaded","error");return}const{jsPDF:e}=window.jspdf,t=new e;t.setFontSize(20),t.text("Tillerstead Tile Installation",20,20),t.setFontSize(12),t.text("Professional Quote",20,28);let a=40;t.setFontSize(14),t.text("Customer Information",20,a),a+=8,t.setFontSize(10),t.text(`Name: ${this.quoteData.customer.name||"N/A"}`,20,a),a+=6,t.text(`Email: ${this.quoteData.customer.email||"N/A"}`,20,a),a+=6,t.text(`Phone: ${this.quoteData.customer.phone||"N/A"}`,20,a),a+=12,t.setFontSize(14),t.text("Project Areas",20,a),a+=8,this.quoteData.areas.forEach((o,s)=>{t.setFontSize(12),t.text(`${s+1}. ${o.name||"Unnamed Area"}`,20,a),a+=6,t.setFontSize(10),t.text(`   Square Footage: ${o.sqft} sq ft`,20,a),a+=5,t.text(`   Material: ${o.material}`,20,a),a+=5,t.text(`   Labor: $${o.labor.toFixed(2)}`,20,a),a+=5,t.text(`   Materials: $${o.materials.toFixed(2)}`,20,a),a+=5,t.text(`   Subtotal: $${o.subtotal.toFixed(2)}`,20,a),a+=10}),a+=10,t.setFontSize(16),t.text(`Total Estimate: $${this.quoteData.total.toFixed(2)}`,20,a),t.setFontSize(8),t.text("This is an estimate. Final pricing may vary based on site conditions.",20,280),t.text("Valid for 30 days from date of issue.",20,285),t.save(`tillerstead-quote-${Date.now()}.pdf`),this.showToast("PDF generated successfully!","success")}setupEmailQuote(){const e=document.getElementById("email-quote");e&&e.addEventListener("click",()=>this.emailQuote())}async emailQuote(){const e=this.quoteData.customer.email||prompt("Enter email address:");if(!e)return;const t=this.generateQuoteHTML();try{(await fetch("/api/send-quote",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,quoteData:this.quoteData,html:t})})).ok?this.showToast("Quote emailed successfully!","success"):this.showToast("Failed to email quote","error")}catch(a){console.error("Email error:",a),this.showToast("Failed to email quote","error")}}generateQuoteHTML(){return`
        <h1>Your Tillerstead Quote</h1>
        <p>Thank you for your interest in professional tile installation!</p>
        <h2>Project Summary</h2>
        ${this.quoteData.areas.map((e,t)=>`
          <div>
            <h3>${t+1}. ${e.name}</h3>
            <p>Square Footage: ${e.sqft} sq ft</p>
            <p>Material: ${e.material}</p>
            <p>Subtotal: $${e.subtotal.toFixed(2)}</p>
          </div>
        `).join("")}
        <h2>Total: $${this.quoteData.total.toFixed(2)}</h2>
      `}setupQuoteSaveLoad(){const e=document.getElementById("save-quote"),t=document.getElementById("load-quote");e&&e.addEventListener("click",()=>this.saveQuote()),t&&t.addEventListener("click",()=>this.loadQuote())}saveQuote(){const e=JSON.parse(localStorage.getItem("tillerstead_quotes")||"[]"),t={id:Date.now(),date:new Date().toISOString(),data:this.quoteData,photos:this.photos};e.push(t),localStorage.setItem("tillerstead_quotes",JSON.stringify(e)),this.showToast("Quote saved!","success")}loadQuote(){const e=JSON.parse(localStorage.getItem("tillerstead_quotes")||"[]");if(e.length===0){this.showToast("No saved quotes found","info");return}const t=e.map(o=>`${new Date(o.date).toLocaleDateString()} - ${o.data.areas.length} areas - $${o.data.total.toFixed(2)}`).join(`
`),a=prompt(`Select a quote:
`+t)}showToast(e,t="info"){console.log(`[${t}] ${e}`)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{window.quoteSystem=new i}):window.quoteSystem=new i})();})();
