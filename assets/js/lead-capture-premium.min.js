(()=>{(function(){"use strict";class o{constructor(){this.leadScore=0,this.leadData={},this.interactions=[],this.init()}init(){this.trackUserBehavior(),this.setupSmartForms(),this.setupExitIntentPopup(),this.setupProgressiveDisclosure(),this.setupLeadScoring()}trackUserBehavior(){const t=Date.now();window.addEventListener("beforeunload",()=>{const a=(Date.now()-t)/1e3;this.addInteraction("time_on_site",{seconds:a})}),this.addInteraction("page_view",{page:window.location.pathname}),document.addEventListener("click",a=>{a.target.closest('[id^="calc-"]')&&(this.addInteraction("calculator_used",{score:10}),this.leadScore+=10)}),document.querySelectorAll('a[href*="portfolio"]').forEach(a=>{a.addEventListener("click",()=>{this.addInteraction("portfolio_view",{score:5}),this.leadScore+=5})}),window.location.pathname.includes("pricing")&&(this.addInteraction("pricing_view",{score:15}),this.leadScore+=15),document.querySelectorAll("[data-service]").forEach(a=>{a.addEventListener("click",()=>{this.addInteraction("service_interest",{service:a.dataset.service,score:8}),this.leadScore+=8})})}addInteraction(t,e){this.interactions.push({type:t,data:e,timestamp:new Date().toISOString()}),localStorage.setItem("tillerstead_interactions",JSON.stringify(this.interactions)),this.checkLeadCaptureThreshold()}setupSmartForms(){document.querySelectorAll(".lead-capture-form").forEach(e=>{e.addEventListener("submit",async a=>{a.preventDefault(),await this.captureLead(new FormData(e))}),e.querySelectorAll("input, textarea").forEach(a=>{a.addEventListener("input",()=>{this.leadData[a.name]=a.value,this.saveLeadProgress()})})})}setupProgressiveDisclosure(){document.querySelectorAll("[data-progressive-form]").forEach(e=>{const s=e.querySelector('[data-step="1"]'),a=e.querySelector('[data-step="2"]'),i=e.querySelector('[data-step="3"]'),n=e.querySelector('input[type="email"]');n&&n.addEventListener("blur",()=>{n.validity.valid&&a&&(a.classList.remove("hidden"),this.addInteraction("form_engagement",{step:2,score:5}),this.leadScore+=5)});const r=e.querySelector('input[type="tel"]');r&&r.addEventListener("blur",()=>{r.value&&i&&(i.classList.remove("hidden"),this.addInteraction("form_engagement",{step:3,score:10}),this.leadScore+=10)})})}setupExitIntentPopup(){let t=!1;const e=()=>{if(t||this.leadScore<20)return;const s=document.getElementById("exit-intent-modal");s&&(s.classList.add("show"),t=!0,this.addInteraction("exit_intent_shown",{score:0}))};document.addEventListener("mouseleave",s=>{s.clientY<0&&e()}),"onpopstate"in window&&window.addEventListener("popstate",e)}setupLeadScoring(){this.scoreThresholds={cold:0,warm:20,hot:50,qualified:80}}getLeadTemperature(){return this.leadScore>=this.scoreThresholds.qualified?"qualified":this.leadScore>=this.scoreThresholds.hot?"hot":this.leadScore>=this.scoreThresholds.warm?"warm":"cold"}checkLeadCaptureThreshold(){this.leadScore>=this.scoreThresholds.warm&&!this.hasContact()&&this.showInlineLeadCapture()}hasContact(){return this.leadData.email||this.leadData.phone}showInlineLeadCapture(){document.querySelectorAll(".smart-lead-banner").forEach(e=>{e.dataset.shown!=="true"&&(e.classList.add("show"),e.dataset.shown="true")})}async captureLead(t){const e=Object.fromEntries(t);this.leadData={...this.leadData,...e},this.leadData.score=this.leadScore,this.leadData.temperature=this.getLeadTemperature(),this.leadData.interactions=this.interactions,this.leadData.timestamp=new Date().toISOString();try{(await fetch("/api/leads/capture",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.leadData)})).ok&&(this.showThankYou(),this.triggerLeadNotification(),typeof gtag!="undefined"&&gtag("event","generate_lead",{value:this.leadScore,currency:"USD"}))}catch(s){console.error("Lead capture error:",s),this.saveLeadLocally()}}saveLeadProgress(){localStorage.setItem("tillerstead_lead_progress",JSON.stringify(this.leadData))}saveLeadLocally(){const t=JSON.parse(localStorage.getItem("tillerstead_leads")||"[]");t.push(this.leadData),localStorage.setItem("tillerstead_leads",JSON.stringify(t))}showThankYou(){const t=document.getElementById("thank-you-modal");t&&t.classList.add("show")}triggerLeadNotification(){console.log("New lead captured:",this.leadData)}}class c{constructor(){this.events=[],this.init()}init(){this.trackConversionFunnel(),this.setupHeatmapTracking(),this.trackFormAbandonment(),this.trackCTAClicks()}trackConversionFunnel(){Object.entries({landing:()=>!0,service_view:()=>!!document.querySelector("[data-service]"),calculator_use:()=>this.hasUsedCalculator(),contact_intent:()=>this.hasContactIntent(),lead_captured:()=>this.hasSubmittedForm()}).forEach(([e,s])=>{s()&&this.trackEvent("funnel_step",{step:e})})}setupHeatmapTracking(){document.addEventListener("click",e=>{const s=e.clientX,a=e.clientY,i=e.target.tagName;this.trackEvent("click",{x:s,y:a,element:i,page:window.location.pathname})});let t=0;window.addEventListener("scroll",()=>{const e=window.scrollY/(document.body.scrollHeight-window.innerHeight)*100;e>t&&(t=e,e>=25&&e<50?this.trackEvent("scroll_depth",{depth:25}):e>=50&&e<75?this.trackEvent("scroll_depth",{depth:50}):e>=75&&e<100?this.trackEvent("scroll_depth",{depth:75}):e>=100&&this.trackEvent("scroll_depth",{depth:100}))})}trackFormAbandonment(){document.querySelectorAll("form").forEach(e=>{let s=!1;e.addEventListener("focus",()=>{s||(s=!0,this.trackEvent("form_started",{form:e.id||e.className}))},!0),e.addEventListener("submit",()=>{this.trackEvent("form_submitted",{form:e.id||e.className})}),window.addEventListener("beforeunload",()=>{s&&!this.hasSubmittedForm()&&this.trackEvent("form_abandoned",{form:e.id||e.className})})})}trackCTAClicks(){document.querySelectorAll(".btn--primary, .cta-button, [data-cta]").forEach(e=>{e.addEventListener("click",()=>{this.trackEvent("cta_click",{text:e.textContent.trim(),href:e.href||"",location:this.getElementPosition(e)})})})}trackEvent(t,e){const s={name:t,data:e,timestamp:new Date().toISOString(),page:window.location.pathname,sessionId:this.getSessionId()};this.events.push(s),this.sendToAnalytics(s),this.saveEventsLocally()}async sendToAnalytics(t){try{await fetch("/api/analytics/track",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}catch(e){console.error("Analytics error:",e)}}saveEventsLocally(){localStorage.setItem("tillerstead_analytics",JSON.stringify(this.events.slice(-100)))}getSessionId(){let t=sessionStorage.getItem("tillerstead_session_id");return t||(t="session_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),sessionStorage.setItem("tillerstead_session_id",t)),t}getElementPosition(t){const e=t.getBoundingClientRect();return{x:e.left,y:e.top,width:e.width,height:e.height}}hasUsedCalculator(){return localStorage.getItem("tillerstead_calc_used")==="true"}hasContactIntent(){return localStorage.getItem("tillerstead_contact_intent")==="true"}hasSubmittedForm(){return localStorage.getItem("tillerstead_form_submitted")==="true"}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{window.leadCapture=new o,window.analytics=new c}):(window.leadCapture=new o,window.analytics=new c)})();})();
